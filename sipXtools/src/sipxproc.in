#!/usr/bin/env ruby

# Copyright (C) 2007 Pingtel Corp., certain elements licensed under a Contributor Agreement.
# Contributors retain copyright to elements licensed under a Contributor Agreement.
# Licensed to the User under the LGPL license.

require 'pp'
require 'getoptlong'
require 'xmlrpc/client'
require 'openssl/x509'

port = "8092" 

# Allow the required SSL certificate information to be set.
module XMLRPC   
   class Client 
      def key=(x)
         @http.key = x
      end
      def cert=(x)
         @http.cert = x
      end
      def verify_mode=(x)
         @http.verify_mode = x
      end
      def cert_store=(x)
         @http.cert_store = x
      end
      def open_timeout=(x)
         @http.open_timeout = x
      end
      def read_timeout=(x)
         @http.read_timeout = x
      end
   end
end

def usage_exit(error_code=1)
      usage = <<__EOU__

  Usage: #{ $0 } parameters

    Interface with the sipXpbx watchdog monitored process XMLRPC interface.

  Parameters:
  -h|--help           This help text
  -n|--host hostname  Remote server, e.g. HA slave (default is localhost)
  -p|--port portnum   Server port (default is 8092)
  -s|--start          Start the specified monitored process 
  -a|--startAll       Start all the monitored processes
  -k|--stop           Stop the specified monitored process
  -j|--stopAll        Stop all the monitored processes
  -r|--restart        Restart the specified monitored process
  -e|--restartAll     Restart all the monitored processes
  -l|--state          Current state of all monitored processes
  -g|--getAliasByPID  Get the monitored process with the specified PID

__EOU__

      STDERR << usage
      exit error_code
end

if __FILE__ == $0
  OptSet = [
      ['--start','-s',         GetoptLong::REQUIRED_ARGUMENT],
      ['--startAll','-a',      GetoptLong::NO_ARGUMENT],
      ['--stop','-k',          GetoptLong::REQUIRED_ARGUMENT],
      ['--stopAll','-j',       GetoptLong::NO_ARGUMENT],
      ['--restart','-r',       GetoptLong::REQUIRED_ARGUMENT],
      ['--restartAll','-e',    GetoptLong::NO_ARGUMENT],
      ['--state','-l',         GetoptLong::NO_ARGUMENT],
      ['--getAliasByPID','-g', GetoptLong::REQUIRED_ARGUMENT],
      ['--host','-n',          GetoptLong::REQUIRED_ARGUMENT],
      ['--port','-p',          GetoptLong::REQUIRED_ARGUMENT],
      ['--help','-h',          GetoptLong::NO_ARGUMENT]
   ]
end

client_host = `hostname -f`.chomp
server_host = String.new(client_host)

# The default action if no other is specified.
action = 'getStateAll'

opts = GetoptLong.new(*OptSet)
argument = nil
block = nil
begin
   opts.each do |name, arg|
      case name
         when '--help'
            usage_exit 0
         when '--getAliasByPID'
            # One integer argument must be specified.
            action = name.gsub(/--/, '')
            argument = arg.to_i
         when '--start', '--stop', '--restart'
            # One string argument must be specified.
            action = name.gsub(/--/, '')
            argument = arg
            block = true
         when '--startAll', '--stopAll', '--restartAll'
            # Applies to all processes (so none can be specified.)
            action = name.gsub(/--/, '')
         when '--state'
            # The default 'action'.  Applies to all processes (so none can be specified.)
         when '--host'
            server_host = arg
         when '--port'
            port = arg
         else
            usage_exit
         end
     end

   rescue StandardError => bang
      puts bang
      usage_exit
   end

if 0 != ARGV.length
   usage_exit
end   

params = [ client_host ]
if argument
   params.push(argument)
end
if block
   params.push(block)
end

client = XMLRPC::Client.new2("https://" << server_host << ":" << port << "/RPC2")

# SSL certificate information
client.verify_mode = OpenSSL::SSL::VERIFY_PEER
client.cert = OpenSSL::X509::Certificate.new(File.read('@SIPX_CONFDIR@/ssl/ssl.crt'))
client.key = OpenSSL::PKey::RSA.new(File.read('@SIPX_CONFDIR@/ssl/ssl.key'))
client.cert_store = OpenSSL::X509::Store.new.add_path('@SIPX_CONFDIR@/ssl/authorities')
client.open_timeout = 10 
client.read_timeout = 60

pp client.call('ProcMgmtRpc.' << action, *params)
#!/usr/bin/env ruby

# Copyright (C) 2007 Pingtel Corp., certain elements licensed under a Contributor Agreement.
# Contributors retain copyright to elements licensed under a Contributor Agreement.
# Licensed to the User under the LGPL license.

require 'pp'
require 'getoptlong'
require 'xmlrpc/client'
require 'openssl/x509'

port = "8092" 

# Allow the required SSL certificate information to be set.
module XMLRPC   
   class Client 
      def key=(x)
         @http.key = x
      end
      def cert=(x)
         @http.cert = x
      end
      def verify_mode=(x)
         @http.verify_mode = x
      end
      def cert_store=(x)
         @http.cert_store = x
      end
      def open_timeout=(x)
         @http.open_timeout = x
      end
      def read_timeout=(x)
         @http.read_timeout = x
      end
   end
end

def usage_exit(error_code=1)
      usage = <<__EOU__

  Usage: #{ $0 } parameters

    Interface with the sipXpbx watchdog monitored process XMLRPC interface.

  Parameters:
  -h|--help           This help text
  -n|--host hostname  Remote server, e.g. HA slave (default is localhost)
  -p|--port portnum   Server port (default is 8092)
  -s|--start          Start the specified monitored process 
  -a|--startAll       Start all the monitored processes
  -k|--stop           Stop the specified monitored process
  -j|--stopAll        Stop all the monitored processes
  -r|--restart        Restart the specified monitored process
  -e|--restartAll     Restart all the monitored processes
  -l|--state          Current state of all monitored processes
  -g|--getAliasByPID  Get the monitored process with the specified PID

__EOU__

      STDERR << usage
      exit error_code
end

if __FILE__ == $0
  OptSet = [
      ['--start','-s',         GetoptLong::REQUIRED_ARGUMENT],
      ['--startAll','-a',      GetoptLong::NO_ARGUMENT],
      ['--stop','-k',          GetoptLong::REQUIRED_ARGUMENT],
      ['--stopAll','-j',       GetoptLong::NO_ARGUMENT],
      ['--restart','-r',       GetoptLong::REQUIRED_ARGUMENT],
      ['--restartAll','-e',    GetoptLong::NO_ARGUMENT],
      ['--state','-l',         GetoptLong::NO_ARGUMENT],
      ['--getAliasByPID','-g', GetoptLong::REQUIRED_ARGUMENT],
      ['--host','-n',          GetoptLong::REQUIRED_ARGUMENT],
      ['--port','-p',          GetoptLong::REQUIRED_ARGUMENT],
      ['--help','-h',          GetoptLong::NO_ARGUMENT]
   ]
end

client_host = `hostname -f`.chomp
server_host = String.new(client_host)

# The default action if no other is specified.
action = 'getStateAll'

opts = GetoptLong.new(*OptSet)
argument = nil
block = nil
begin
   opts.each do |name, arg|
      case name
         when '--help'
            usage_exit 0
         when '--getAliasByPID'
            # One integer argument must be specified.
            action = name.gsub(/--/, '')
            argument = arg.to_i
         when '--start', '--stop', '--restart'
            # One string argument must be specified.
            action = name.gsub(/--/, '')
            argument = arg
            block = true
         when '--startAll', '--stopAll', '--restartAll'
            # Applies to all processes (so none can be specified.)
            action = name.gsub(/--/, '')
         when '--state'
            # The default 'action'.  Applies to all processes (so none can be specified.)
         when '--host'
            server_host = arg
         when '--port'
            port = arg
         else
            usage_exit
         end
     end

   rescue StandardError => bang
      puts bang
      usage_exit
   end

if 0 != ARGV.length
   usage_exit
end   

params = [ client_host ]
if argument
   params.push(argument)
end
if block
   params.push(block)
end

client = XMLRPC::Client.new2("https://" << server_host << ":" << port << "/RPC2")

# SSL certificate information
client.verify_mode = OpenSSL::SSL::VERIFY_PEER
client.cert = OpenSSL::X509::Certificate.new(File.read('@SIPX_CONFDIR@/ssl/ssl.crt'))
client.key = OpenSSL::PKey::RSA.new(File.read('@SIPX_CONFDIR@/ssl/ssl.key'))
client.cert_store = OpenSSL::X509::Store.new.add_path('@SIPX_CONFDIR@/ssl/authorities')
client.open_timeout = 10 
client.read_timeout = 60

pp client.call('ProcMgmtRpc.' << action, *params)
