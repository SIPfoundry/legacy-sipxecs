#!/bin/bash

# Update registrar-config.in to use the plugin redirector system.

# Note @SIPX_CONFDIR@ does not need a following "sipxpbx".

if ! grep '^SIP_REDIRECT_HOOK_LIBRARY\.' @SIPX_CONFDIR@/registrar-config.in > /dev/null
then
	# Get the sipx_config_value function.
	. @SIPX_LIBEXECDIR@/sipx-utils.sh || exit 1

	# Copy registrar-config.in, but remove any SIP_REDIRECT.190-ISN.BASE_DOMAIN
	# present (it may have been generated by Config Server), and the lines whose values
	# we copy into new lines.
	cp @SIPX_CONFDIR@/registrar-config.in @SIPX_CONFDIR@/registrar-config.in.old
	(
	    echo "^ *SIP_REDIRECT.190-ISN\.BASE_DOMAIN *:"
	    echo "^ *SIP_REGISTRAR_AUTH_PROXY *:"
	    echo "^ *SIP_REGISTRAR_CALL_PICKUP_WAIT *:"
	    echo "^ *SIP_REGISTRAR_CALL_RETRIEVE_CODE *:"
	    echo "^ *SIP_REGISTRAR_DIRECTED_CALL_PICKUP_CODE *:"
	    echo "^ *SIP_REGISTRAR_GLOBAL_CALL_PICKUP_CODE *:"
	    echo "^ *SIP_REGISTRAR_MEDIA_SERVER *:"
	    echo "^ *SIP_REGISTRAR_PARK_SERVER *:"
	    echo "^ *SIP_REGISTRAR_VOICEMAIL_SERVER *:"
	) > @SIPX_CONFDIR@/registrar-config.pats.tmp
	grep -vf @SIPX_CONFDIR@/registrar-config.pats.tmp \
	        < @SIPX_CONFDIR@/registrar-config.in.old \
		> @SIPX_CONFDIR@/registrar-config.in
	# Append the new lines.
	(
	    echo ""
	    echo "# Configure the redirectors."
	    echo "SIP_REDIRECT_HOOK_LIBRARY.110-REG : @SIPX_LIBDIR@/libRedirectorRegDB.so"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.120-ALIAS : @SIPX_LIBDIR@/libRedirectorAliasDB.so"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.130-SUBSCRIBE : @SIPX_LIBDIR@/libRedirectorSubscribe.so"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.140-MAPPING : @SIPX_LIBDIR@/libRedirectorMapping.so"
	    echo "SIP_REDIRECT.140-MAPPING.MEDIA_SERVER : \${MEDIA_SERVER_SIP_SRV_OR_HOSTPORT}"
	    echo "SIP_REDIRECT.140-MAPPING.VOICEMAIL_SERVER : https%3A%2F%2Flocalhost%3A\${VOICEMAIL_SERVER_HTTPS_PORT}"
	    echo "SIP_REDIRECT.140-MAPPING.MAPPING_RULES_FILENAME : @SIPX_CONFDIR@/mappingrules.xml"
	    echo "SIP_REDIRECT.140-MAPPING.FALLBACK : false"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.150-FALLBACK : @SIPX_LIBDIR@/libRedirectorMapping.so"
	    echo "SIP_REDIRECT.150-FALLBACK.MEDIA_SERVER : \${MEDIA_SERVER_SIP_SRV_OR_HOSTPORT}"
	    echo "SIP_REDIRECT.150-FALLBACK.VOICEMAIL_SERVER : https%3A%2F%2Flocalhost%3A\${VOICEMAIL_SERVER_HTTPS_PORT}"
	    echo "SIP_REDIRECT.150-FALLBACK.MAPPING_RULES_FILENAME : @SIPX_CONFDIR@/fallbackrules.xml"
	    echo "SIP_REDIRECT.150-FALLBACK.FALLBACK : true"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.160-HUNT : @SIPX_LIBDIR@/libRedirectorHunt.so"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.180-PICKUP : @SIPX_LIBDIR@/libRedirectorPickUp.so"
	    echo "SIP_REDIRECT.180-PICKUP.PICKUP_1_SEC_SUBSCRIBE : Y"
	    echo "SIP_REDIRECT.180-PICKUP.PICKUP_REVERSED_REPLACES : N"
	    echo "SIP_REDIRECT.180-PICKUP.PICKUP_NO_EARLY_ONLY : Y"
	    echo "SIP_REDIRECT.180-PICKUP.GLOBAL_CALL_PICKUP_CODE : `sipx_config_value @SIPX_CONFDIR@/registrar-config.in.old SIP_REGISTRAR_GLOBAL_CALL_PICKUP_CODE`"
	    echo "SIP_REDIRECT.180-PICKUP.DIRECTED_CALL_PICKUP_CODE : `sipx_config_value @SIPX_CONFDIR@/registrar-config.in.old SIP_REGISTRAR_DIRECTED_CALL_PICKUP_CODE`"
	    echo "SIP_REDIRECT.180-PICKUP.CALL_RETRIEVE_CODE : `sipx_config_value @SIPX_CONFDIR@/registrar-config.in.old SIP_REGISTRAR_CALL_RETRIEVE_CODE`"
	    echo "SIP_REDIRECT.180-PICKUP.CALL_PICKUP_WAIT : `sipx_config_value @SIPX_CONFDIR@/registrar-config.in.old SIP_REGISTRAR_CALL_PICKUP_WAIT`"
	    echo "SIP_REDIRECT.180-PICKUP.PARK_SERVER : \${ORBIT_SERVER_SIP_SRV_OR_HOSTPORT}"
	    echo "SIP_REDIRECT.180-PICKUP.ORBIT_FILENAME : @SIPX_CONFDIR@/orbits.xml"
	    echo "SIP_REDIRECT_HOOK_LIBRARY.190-ISN : @SIPX_LIBDIR@/libRedirectorISN.so"
	    echo "SIP_REDIRECT.190-ISN.BASE_DOMAIN : "
	    echo "SIP_REDIRECT_HOOK_LIBRARY.999-AUTHROUTER : @SIPX_LIBDIR@/libRedirectorAuthRouter.so"
	    echo "SIP_REDIRECT.999-AUTHROUTER.AUTH_PROXY : \${AUTH_PROXY_SERVER_SIP_SRV_OR_HOSTPORT}"
	) >> @SIPX_CONFDIR@/registrar-config.in
fi
